#!/usr/bin/env python3
"""
Script de prueba para la implementaci√≥n de SpeechDPR.
Verifica que el modelo se pueda cargar correctamente y generar embeddings.
"""

import sys
import os
import logging
from pathlib import Path

CURRENT_FILE = Path(__file__).resolve()
TESTS_ROOT = CURRENT_FILE
while TESTS_ROOT.name != "tests" and TESTS_ROOT.parent != TESTS_ROOT:
    TESTS_ROOT = TESTS_ROOT.parent
if str(TESTS_ROOT) not in sys.path:
    sys.path.insert(0, str(TESTS_ROOT))

from tests.common.path_utils import ensure_sys_path, SRC_ROOT

ensure_sys_path([SRC_ROOT])

# Configurar logging
logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')
logger = logging.getLogger(__name__)

def test_speechdpr_availability():
    """Prueba si las dependencias de SpeechDPR est√°n disponibles"""
    print("üîç Verificando disponibilidad de SpeechDPR...")

    try:
        import torch
        print(f"‚úÖ PyTorch: {torch.__version__}")

        import transformers
        print(f"‚úÖ Transformers: {transformers.__version__}")

        # Verificar si CUDA est√° disponible
        if torch.cuda.is_available():
            print(f"‚úÖ CUDA disponible: {torch.cuda.get_device_name()}")
        elif hasattr(torch.backends, 'mps') and torch.backends.mps.is_available():
            print("‚úÖ MPS (Apple Silicon) disponible")
        else:
            print("‚ÑπÔ∏è  Solo CPU disponible")

        return True

    except ImportError as e:
        print(f"‚ùå Dependencias faltantes: {e}")
        print("üí° Instala con: pip install torch transformers")
        return False

def test_speechdpr_import():
    """Prueba importar el m√≥dulo SpeechDPR"""
    print("\nüì¶ Probando importaci√≥n de SpeechDPR...")

    try:
        from speechdpr_audio_embeddings import (
            SpeechDPRAudioEmbeddingGenerator,
            SpeechDPRConfig,
            get_speechdpr_embedding_generator,
            SPEECHDPR_AVAILABLE
        )

        print("‚úÖ M√≥dulo SpeechDPR importado correctamente")
        print(f"üìä SpeechDPR disponible: {SPEECHDPR_AVAILABLE}")

        return True, (SpeechDPRAudioEmbeddingGenerator, SpeechDPRConfig, get_speechdpr_embedding_generator)

    except ImportError as e:
        print(f"‚ùå Error importando SpeechDPR: {e}")
        return False, None

def test_config_integration():
    """Prueba la integraci√≥n con models_config.py"""
    print("\n‚öôÔ∏è  Probando integraci√≥n con configuraci√≥n...")

    try:
        from models_config import (
            get_models_config,
            AudioEmbeddingModel,
            SpeechDPRConfig,
            ModelsConfigLoader
        )

        # Verificar que SpeechDPR est√° en el enum
        assert AudioEmbeddingModel.SPEECHDPR.value == "speechdpr"
        print("‚úÖ SpeechDPR integrado en AudioEmbeddingModel")

        # Cargar configuraci√≥n
        config = get_models_config()
        print(f"‚úÖ Configuraci√≥n cargada: {type(config.speechdpr_config)}")

        # Verificar configuraci√≥n de SpeechDPR
        speechdpr_config = config.speechdpr_config
        print(f"üìê Embedding dim: {speechdpr_config.embedding_dim}")
        print(f"üé§ Speech model: {speechdpr_config.speech_encoder_model}")
        print(f"üìù Text model: {speechdpr_config.text_encoder_model}")

        # Probar disponibilidad
        available = config.is_model_available(
            config.ModelType.AUDIO_EMBEDDING if hasattr(config, 'ModelType') else type('ModelType', (), {'AUDIO_EMBEDDING': 'audio_embedding'})(),
            "speechdpr"
        )
        print(f"üìä SpeechDPR disponible seg√∫n config: {available}")

        return True

    except Exception as e:
        print(f"‚ùå Error en integraci√≥n de configuraci√≥n: {e}")
        return False

def test_speechdpr_initialization():
    """Prueba inicializar el generador SpeechDPR"""
    print("\nüöÄ Probando inicializaci√≥n de SpeechDPR...")

    try:
        from speechdpr_audio_embeddings import get_speechdpr_embedding_generator, SpeechDPRConfig

        # Crear configuraci√≥n de prueba (modelos m√°s peque√±os si es posible)
        test_config = SpeechDPRConfig()
        test_config.speech_encoder_model = "facebook/hubert-base-ls960"  # Modelo m√°s peque√±o
        test_config.max_audio_length = 10  # Duraci√≥n m√°s corta para pruebas

        print(f"üìã Configuraci√≥n de prueba:")
        print(f"   Speech Encoder: {test_config.speech_encoder_model}")
        print(f"   Text Encoder: {test_config.text_encoder_model}")
        print(f"   Device: {test_config.device}")
        print(f"   Max Audio Length: {test_config.max_audio_length}s")

        # Intentar inicializar
        print("üîÑ Inicializando generador SpeechDPR...")
        embedder = get_speechdpr_embedding_generator(test_config)

        print("‚úÖ SpeechDPR inicializado correctamente")
        print(f"üìê Dimensi√≥n de embeddings: {embedder.embedding_dim}")
        print(f"üñ•Ô∏è  Device: {embedder.device}")

        return True, embedder

    except Exception as e:
        print(f"‚ùå Error inicializando SpeechDPR: {e}")
        return False, None

def test_text_embedding():
    """Prueba generar embedding de texto"""
    print("\nüìù Probando generaci√≥n de embedding de texto...")

    try:
        from speechdpr_audio_embeddings import get_speechdpr_embedding_generator, SpeechDPRConfig

        test_config = SpeechDPRConfig()
        test_config.speech_encoder_model = "facebook/hubert-base-ls960"

        embedder = get_speechdpr_embedding_generator(test_config)

        # Texto de prueba
        test_text = "discurso pol√≠tico sobre econom√≠a"
        print(f"üî§ Texto de prueba: '{test_text}'")

        # Generar embedding
        text_embedding = embedder.generate_text_embedding(test_text)

        print(f"‚úÖ Embedding de texto generado")
        print(f"üìä Shape: {text_embedding.shape}")
        print(f"üìà Tipo: {type(text_embedding)}")
        print(f"üî¢ Primeros valores: {text_embedding[:5]}")

        return True

    except Exception as e:
        print(f"‚ùå Error generando embedding de texto: {e}")
        return False

def test_models_config_summary():
    """Prueba el resumen de configuraci√≥n con SpeechDPR"""
    print("\nüìä Probando resumen de configuraci√≥n...")

    try:
        from models_config import ModelsConfigLoader

        loader = ModelsConfigLoader()
        config = loader.load_config()

        # Mostrar modelos disponibles
        available_models = config.get_available_models(
            type('ModelType', (), {'AUDIO_EMBEDDING': 'audio_embedding'})()
        )
        print(f"üéµ Modelos de audio embedding disponibles: {available_models}")

        # Validar configuraci√≥n
        validation = config.validate_configuration()
        print(f"‚úÖ Configuraci√≥n v√°lida: {validation['valid']}")

        if validation['warnings']:
            print("‚ö†Ô∏è  Advertencias:")
            for warning in validation['warnings']:
                print(f"   - {warning}")

        if validation['recommended_changes']:
            print("üí° Recomendaciones:")
            for rec in validation['recommended_changes']:
                print(f"   - {rec}")

        return True

    except Exception as e:
        print(f"‚ùå Error en resumen de configuraci√≥n: {e}")
        return False

def main():
    """Funci√≥n principal que ejecuta todas las pruebas"""
    print("üé§ Pruebas de Implementaci√≥n de SpeechDPR")
    print("=" * 50)

    # Lista de pruebas
    tests = [
        ("Disponibilidad de dependencias", test_speechdpr_availability),
        ("Importaci√≥n del m√≥dulo", test_speechdpr_import),
        ("Integraci√≥n con configuraci√≥n", test_config_integration),
        ("Resumen de configuraci√≥n", test_models_config_summary),
    ]

    # Pruebas que requieren dependencias
    advanced_tests = [
        ("Inicializaci√≥n de SpeechDPR", test_speechdpr_initialization),
        ("Generaci√≥n de embedding de texto", test_text_embedding),
    ]

    results = {}

    # Ejecutar pruebas b√°sicas
    for test_name, test_func in tests:
        print(f"\n{'='*50}")
        print(f"Ejecutando: {test_name}")
        print(f"{'='*50}")

        try:
            result = test_func()
            if isinstance(result, tuple):
                results[test_name] = result[0]
            else:
                results[test_name] = result
        except Exception as e:
            print(f"‚ùå Error inesperado en {test_name}: {e}")
            results[test_name] = False

    # Solo ejecutar pruebas avanzadas si las dependencias est√°n disponibles
    if results.get("Disponibilidad de dependencias", False):
        for test_name, test_func in advanced_tests:
            print(f"\n{'='*50}")
            print(f"Ejecutando: {test_name}")
            print(f"{'='*50}")

            try:
                result = test_func()
                if isinstance(result, tuple):
                    results[test_name] = result[0]
                else:
                    results[test_name] = result
            except Exception as e:
                print(f"‚ùå Error inesperado en {test_name}: {e}")
                results[test_name] = False
    else:
        print("\n‚ö†Ô∏è  Saltando pruebas avanzadas debido a dependencias faltantes")

    # Resumen final
    print(f"\n{'='*50}")
    print("üìä RESUMEN DE PRUEBAS")
    print(f"{'='*50}")

    passed = 0
    total = len(results)

    for test_name, success in results.items():
        status = "‚úÖ PASS" if success else "‚ùå FAIL"
        print(f"{status} {test_name}")
        if success:
            passed += 1

    print(f"\nüìà Resultados: {passed}/{total} pruebas exitosas")

    if passed == total:
        print("üéâ ¬°Todas las pruebas pasaron! SpeechDPR est√° listo para usar.")
    elif passed > 0:
        print("‚ö†Ô∏è  Algunas pruebas fallaron. Verifica las dependencias e instalaci√≥n.")
    else:
        print("‚ùå Todas las pruebas fallaron. Revisa la instalaci√≥n.")

    return passed == total

if __name__ == "__main__":
    try:
        success = main()
        sys.exit(0 if success else 1)
    except KeyboardInterrupt:
        print("\nüõë Pruebas interrumpidas por el usuario")
        sys.exit(1)
    except Exception as e:
        print(f"\nüí• Error inesperado: {e}")
        import traceback
        traceback.print_exc()
        sys.exit(1)
